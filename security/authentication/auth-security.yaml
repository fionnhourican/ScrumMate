# Copyright (c) 2025 Telefonaktiebolaget LM Ericsson
# ScrumMate Authentication Security Configuration

apiVersion: v1
kind: ConfigMap
metadata:
  name: auth-security-config
  namespace: scrummate-prod
data:
  security.properties: |
    # Password policies
    password.min.length=12
    password.require.uppercase=true
    password.require.lowercase=true
    password.require.numbers=true
    password.require.special.chars=true
    password.max.age.days=90
    password.history.count=5
    
    # Account lockout policies
    account.lockout.attempts=5
    account.lockout.duration.minutes=30
    account.lockout.reset.time.minutes=60
    
    # Session management
    session.timeout.minutes=30
    session.max.concurrent=3
    session.secure.cookie=true
    session.http.only=true
    session.same.site=strict
    
    # MFA settings
    mfa.enabled=true
    mfa.required.for.admin=true
    mfa.totp.issuer=ScrumMate
    mfa.backup.codes.count=10
    
    # Brute force protection
    brute.force.protection.enabled=true
    brute.force.max.attempts=3
    brute.force.window.minutes=15
    brute.force.ban.duration.minutes=60
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: auth-service
  namespace: scrummate-prod
spec:
  replicas: 2
  selector:
    matchLabels:
      app: auth-service
  template:
    metadata:
      labels:
        app: auth-service
    spec:
      containers:
      - name: auth-service
        image: scrummate/auth-service:latest
        ports:
        - containerPort: 8081
        env:
        - name: SPRING_PROFILES_ACTIVE
          value: "prod"
        - name: VAULT_ADDR
          value: "https://vault.security.svc.cluster.local:8200"
        - name: VAULT_TOKEN
          valueFrom:
            secretKeyRef:
              name: vault-token
              key: token
        resources:
          requests:
            memory: 512Mi
            cpu: 250m
          limits:
            memory: 1Gi
            cpu: 500m
        volumeMounts:
        - name: auth-config
          mountPath: /app/config
        - name: tls-certs
          mountPath: /app/certs
        livenessProbe:
          httpGet:
            path: /actuator/health
            port: 8081
            scheme: HTTPS
          initialDelaySeconds: 60
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /actuator/health/readiness
            port: 8081
            scheme: HTTPS
          initialDelaySeconds: 30
          periodSeconds: 10
      volumes:
      - name: auth-config
        configMap:
          name: auth-security-config
      - name: tls-certs
        secret:
          secretName: auth-tls-certs
---
apiVersion: v1
kind: Service
metadata:
  name: auth-service
  namespace: scrummate-prod
spec:
  selector:
    app: auth-service
  ports:
  - port: 8081
    targetPort: 8081
  type: ClusterIP
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: auth-service-policy
  namespace: scrummate-prod
spec:
  podSelector:
    matchLabels:
      app: auth-service
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: scrummate-backend
    ports:
    - protocol: TCP
      port: 8081
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          name: security
    ports:
    - protocol: TCP
      port: 8200
  - to: []
    ports:
    - protocol: TCP
      port: 53
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 443
