# Production environment configuration for Helmfile

# Infrastructure components
certManager:
  enabled: true

ingressNginx:
  enabled: true

monitoring:
  enabled: true
  grafana:
    adminPassword: ""  # Set via secrets

# Application-specific overrides
scrummate:
  global:
    environment: prod
    imagePullSecrets:
      - name: scrummate-prod-registry-secret
  
  backend:
    replicaCount: 3
    resources:
      requests:
        cpu: 500m
        memory: 512Mi
      limits:
        cpu: 1000m
        memory: 1Gi
    autoscaling:
      enabled: true
      minReplicas: 3
      maxReplicas: 15
      targetCPUUtilizationPercentage: 70
      targetMemoryUtilizationPercentage: 80
    affinity:
      podAntiAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
        - labelSelector:
            matchExpressions:
            - key: app.kubernetes.io/component
              operator: In
              values:
              - backend
          topologyKey: kubernetes.io/hostname
  
  frontend:
    replicaCount: 5
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 256Mi
    autoscaling:
      enabled: true
      minReplicas: 5
      maxReplicas: 20
      targetCPUUtilizationPercentage: 60
      targetMemoryUtilizationPercentage: 70
    affinity:
      podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchExpressions:
              - key: app.kubernetes.io/component
                operator: In
                values:
                - frontend
            topologyKey: kubernetes.io/hostname
  
  postgresql:
    enabled: true
    auth:
      database: scrummate_prod
      username: scrummate_prod
      existingSecret: scrummate-prod-db-secret
    primary:
      persistence:
        size: 20Gi
        storageClass: fast-ssd
      resources:
        requests:
          cpu: 500m
          memory: 512Mi
        limits:
          cpu: 1000m
          memory: 1Gi
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: node-type
                operator: In
                values:
                - database
  
  ingress:
    enabled: true
    annotations:
      nginx.ingress.kubernetes.io/rate-limit: "500"
      nginx.ingress.kubernetes.io/rate-limit-window: "1m"
      nginx.ingress.kubernetes.io/ssl-redirect: "true"
      nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    hosts:
      - host: scrummate.company.com
        paths:
          - path: /
            pathType: Prefix
            service: frontend
      - host: api.scrummate.company.com
        paths:
          - path: /
            pathType: Prefix
            service: backend
    tls:
      - secretName: scrummate-prod-tls
        hosts:
          - scrummate.company.com
          - api.scrummate.company.com
  
  networkPolicies:
    enabled: true
  
  monitoring:
    enabled: true
    serviceMonitor:
      enabled: true
      interval: 30s
      path: /actuator/prometheus
  
  backup:
    enabled: true
    schedule: "0 2 * * *"
    retention: 30
  
  securityContext:
    runAsNonRoot: true
    runAsUser: 65534
    readOnlyRootFilesystem: true
    allowPrivilegeEscalation: false
    capabilities:
      drop:
        - ALL
    seccompProfile:
      type: RuntimeDefault
