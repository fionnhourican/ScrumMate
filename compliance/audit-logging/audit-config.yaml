# Copyright (c) 2025 Telefonaktiebolaget LM Ericsson
# ScrumMate Audit Logging Configuration

apiVersion: v1
kind: ConfigMap
metadata:
  name: kubernetes-audit-policy
  namespace: kube-system
data:
  audit-policy.yaml: |
    apiVersion: audit.k8s.io/v1
    kind: Policy
    rules:
    # Log all requests to ScrumMate namespaces
    - level: RequestResponse
      namespaces: ["scrummate-dev", "scrummate-staging", "scrummate-prod"]
      resources:
      - group: ""
        resources: ["pods", "services", "secrets", "configmaps"]
      - group: "apps"
        resources: ["deployments", "replicasets"]
    
    # Log security-related events
    - level: RequestResponse
      resources:
      - group: "rbac.authorization.k8s.io"
        resources: ["roles", "rolebindings", "clusterroles", "clusterrolebindings"]
    
    # Log admission controller decisions
    - level: Request
      users: ["system:serviceaccount:gatekeeper-system:gatekeeper-admin"]
    
    # Log authentication failures
    - level: Metadata
      omitStages:
      - RequestReceived
      resources:
      - group: ""
        resources: ["events"]
      namespaces: ["default", "kube-system"]
    
    # Don't log routine health checks
    - level: None
      users: ["system:kube-proxy"]
      verbs: ["watch"]
      resources:
      - group: ""
        resources: ["endpoints", "services"]
    
    # Default rule - log everything else at Metadata level
    - level: Metadata
      omitStages:
      - RequestReceived
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: audit-log-processor
  namespace: logging
spec:
  replicas: 2
  selector:
    matchLabels:
      app: audit-log-processor
  template:
    metadata:
      labels:
        app: audit-log-processor
    spec:
      containers:
      - name: audit-processor
        image: fluent/fluent-bit:2.2.0
        ports:
        - containerPort: 2020
        resources:
          requests:
            memory: 256Mi
            cpu: 100m
          limits:
            memory: 512Mi
            cpu: 200m
        volumeMounts:
        - name: fluent-bit-config
          mountPath: /fluent-bit/etc
        - name: audit-logs
          mountPath: /var/log/audit
          readOnly: true
      volumes:
      - name: fluent-bit-config
        configMap:
          name: fluent-bit-audit-config
      - name: audit-logs
        hostPath:
          path: /var/log/audit
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: fluent-bit-audit-config
  namespace: logging
data:
  fluent-bit.conf: |
    [SERVICE]
        Flush         1
        Log_Level     info
        Daemon        off
        Parsers_File  parsers.conf
        HTTP_Server   On
        HTTP_Listen   0.0.0.0
        HTTP_Port     2020
    
    [INPUT]
        Name              tail
        Path              /var/log/audit/audit.log
        Parser            k8s-audit
        Tag               k8s.audit
        Refresh_Interval  5
        Mem_Buf_Limit     50MB
        Skip_Long_Lines   On
    
    [FILTER]
        Name                kubernetes
        Match               k8s.*
        Kube_URL            https://kubernetes.default.svc:443
        Kube_CA_File        /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
        Kube_Token_File     /var/run/secrets/kubernetes.io/serviceaccount/token
        Merge_Log           On
        K8S-Logging.Parser  On
        K8S-Logging.Exclude Off
    
    [FILTER]
        Name    grep
        Match   k8s.audit
        Regex   verb (create|update|delete|patch)
    
    [OUTPUT]
        Name  es
        Match k8s.audit
        Host  scrummate-elasticsearch-es-http.logging
        Port  9200
        Index audit-logs
        Type  _doc
        HTTP_User elastic
        HTTP_Passwd ${ELASTICSEARCH_PASSWORD}
        tls   On
        tls.verify Off
  
  parsers.conf: |
    [PARSER]
        Name        k8s-audit
        Format      json
        Time_Key    timestamp
        Time_Format %Y-%m-%dT%H:%M:%S.%L%z
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: audit-trail-analyzer
  namespace: logging
spec:
  schedule: "0 2 * * *"
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: audit-analyzer
            image: curlimages/curl:latest
            command:
            - /bin/sh
            - -c
            - |
              # Analyze audit trails for compliance
              curl -X POST "https://scrummate-elasticsearch-es-http.logging:9200/audit-logs/_search" \
                -H "Content-Type: application/json" \
                -u "elastic:${ELASTICSEARCH_PASSWORD}" \
                -d '{
                  "query": {
                    "bool": {
                      "must": [
                        {
                          "range": {
                            "@timestamp": {
                              "gte": "now-24h"
                            }
                          }
                        },
                        {
                          "terms": {
                            "verb": ["create", "update", "delete"]
                          }
                        }
                      ]
                    }
                  },
                  "aggs": {
                    "by_user": {
                      "terms": {
                        "field": "user.username.keyword",
                        "size": 50
                      }
                    },
                    "by_resource": {
                      "terms": {
                        "field": "objectRef.resource.keyword",
                        "size": 20
                      }
                    }
                  }
                }' > /tmp/audit-analysis.json
              
              # Send compliance report
              curl -X POST "${COMPLIANCE_WEBHOOK_URL}" \
                -H "Content-Type: application/json" \
                -d @/tmp/audit-analysis.json
            env:
            - name: ELASTICSEARCH_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: elasticsearch-credentials
                  key: password
            - name: COMPLIANCE_WEBHOOK_URL
              value: "https://compliance.company.com/audit-reports"
          restartPolicy: OnFailure
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: audit-log-processor
  namespace: logging
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: audit-log-processor
rules:
- apiGroups: [""]
  resources: ["pods", "namespaces"]
  verbs: ["get", "list", "watch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: audit-log-processor
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: audit-log-processor
subjects:
- kind: ServiceAccount
  name: audit-log-processor
  namespace: logging
